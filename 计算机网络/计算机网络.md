# 计算机网络

## 概述

### 1.2 因特网概述

* 网络、互联网、因特网

  * 网络(Network)由若干节点(Node)和连接这些节点的链路(Link)组成
  * 多个网络可以通过路由器互联起来，这样就构成了一个覆盖范围更大的网络，即互联网。因此互联网是“网络的网络”。（Network of Networks）
  * 英特网是世界上最大的互联网络。
  * 因特网服务提供者ISP(Internet Service Provider)

* 因特网发展的三个阶段

  * 略

* 因特网的标准化工作

  * 略

* 因特网的组成

  * 边缘部分：由所有连接在因特网上的主机组成。这部分是用户直接使用的，用来进行通信和资源共享。
  * 核心部分：由大量网络和连接网络的路由器组，这部分是为边缘部分提供服务的

### 1.3 三种交换方式

* 电路交换

  * 电话交换机接通电话线的方法称为电路交换。
  * 从通信资源的分配角度上看，交换就是按照某种方法动态分配传输线路的资源。
  * 电路交换三个步骤。
    1. 建立连接(分配通信资源)
    2. 通话(一直占用通信资源)
    3. 释放连接(归还通信资源)

    ![图片](images/Screenshot%202023-06-23%20144529.png)

当使用电路交换来传输计算机数据，其线路的传输效率往往很低

* 分组交换

    将数据分组并添加首部

  * 发送方：构造分组，发送分组
  * 路由器：缓存分组，转发分组
  * 接收方：接受分组，还原报文

    ![图片](images/Screenshot%202023-06-23%20150119.png)

* 报文交换

  * 略

三种方法对比

![图片](images/Screenshot%202023-06-23%20151356.png)

### 1.4 计算机网络的定义和分类

* 计算机网络的定义

  * 计算机网络的精确定义并未统一
  * 计算机网络的简单定义是：一些互相连接的，自治的计算机上的集合
    * 互联：计算机之间可以通过有线或无线的方式进行数据通信
    * 自治：指独立的计算机还有自己的软件和，它有自己的软件和硬件，可以独立运行。
    * 集合：至少需要两台计算机。
  * 计算机网络较好的定义是:计算机网络主要由一些通用的可编程的应件互联而成。而这些硬件并非专门用来实现某一特定目的。这些可编程的硬件用传输多种不同的数据类型，并能支持广泛的和日益增长应用。
    * 计算机算所连接的硬件，并不限于一般计算机。而是包括了智能手机等智能硬件。
    * 计算机网络并非专门用来传输数据，而是能够支持很多种应用

* 计算机网络的分类

  * 按交换技术
    * 电路交换网络
    * 报文交换网络
    * 分组交换网络
  * 按使用者
    * 公用网
    * 专用网
  * 按传输介质
    * 有线网络
    * 无线网络
  * 按覆盖范围分类
    * 广域网WAN
    * 城域网MAN
    * 局域网LAN
    * 个域网PAN
  * 按拓扑结构分类
    * 总线型网络
    * 星型络网
    * 环形网络
    * 网状型网络

### 计算机网络的性能指标

* 性能指标可以从不同的方面来度量计算机网络的性能。
* 常用的计算机网络性能指标有以下八个。
    1. **速率**

        连接在计算机网络上的主机在数字信道上传送比特的速率，也称为比特率或数据率。
        **常用数据率单位**
        *bit/s(b/s,bps)*
        *kb/s* = 10^3^ *b/s*
        *Mb/s* = k\**kb/s* = 10^3^\*10^3^ *b/s*

    2. **带宽**

        用来表示网络的通信线路所能传输数据的能力。因此网络带宽表示在单位时间内从网络中的某一点到另一点所能通过的**最高数据率**。
        单位：b/s (kb/s,Mb/s)

    3. **吞吐量**

        吞吐量表示在单位时间内通过某个网络的数据量
        吞吐量被经常用于对现实世界中的网络的一种测量以便知道实际上到底有多少数据量能够通过网络
        吞吐量受网络的宽带或额定速率的限制。

    4. **时延**

        发送时延：分组长度(b)/发送速率(b/s)
        传播时延: 信道长度(m)/电磁波传输速率(m/s)
        处理时延: 不方便计算

    5. **时延带宽积**

        时延带宽积 = 传播时延\*带宽
        若发送端连续发送数据，所在所发送的第一个比特即将到达终点时，发送端就已经发送了迟延带宽积个比特
        链路的时延带宽积又称为以比特为单位的链路长度

    6. **往返时间**

        在许多情况下，因特网上的信息不仅仅单方面运输，而是双向交互
        我们有时很需要知道双向交互一次所需的时间
        因此，往返时间RTT(Round-Trip Time)也是一个重要的指标

    7. **利用率**

        信道利用率：用来表示某信道有百分之几的时间是被利用的(有数据通过)
        网络利用率：全网络的信道利用率的加权平均
        **为什么下载游戏网会卡**
        * 更具排队论，当某信道的利用率增大时，该信道的延迟也会迅速增加 因此，信道利用率并非越高越好
        * 如果令D~0~表示网络空闲时的延时，D表示网络当前延时 它们的关系如下公式 D=D~0~/1-U
          * 当网络的利用率达到50%，时延就加倍
        * 信道利用率也不能太低，否则会浪费资源

    8. hg

        丢包率：分组丢失率，是指在一定的时间范围内，传输过程中丢失的分组数量与总分组数量的比率
        分组丢失的两个重要原因：分组误码，结点交换机缓存队列满(网络拥挤)

### 1.7 计算机网络体系结构

* 常见的计算机网络体系结构

  OSI体系系统

  ![图片](images/Screenshot%202023-06-24%20145337.png)

      OSI体系的失败原因

  TCP/IP体系结构

  ![图片](images/Screenshot%202023-06-24%20145604.png)

  工作方式

  ![图片](images/Screenshot%202023-06-24%20150333.png)

  原理体系结构

  ![图片](images/Screenshot%202023-06-24%20150222.png)

* 计算机网络结构分层的必要性

  计算机网络是个非常复杂的系统。早在最初的ARPANET设计时就提出了分层的设计理念
  分层可将庞大复杂的问题，转化为若干个较小的局部问题，而这些较小的局部问题就比较易于研究和处理

  * 物理层

      ![图片](images/Screenshot%202023-06-24%20151956.png)
  * 数据链路层

      ![图片](images/Screenshot%202023-06-24%20152159.png)
  * 网络层

      ![图片](images/Screenshot%202023-06-24%20152308.png)
  * 运输层

      ![图片](images/Screenshot%202023-06-24%20152425.png)
  * 应用层

      ![图片](images/Screenshot%202023-06-24%20152512.png)

  ![图片](images/Screenshot%202023-06-24%20152618.png)

* 计算机网络结构分层思想举例

  ![图片](images/Screenshot%202023-06-24%20153316.png)

* 计算机网络结构中的专业术语

  * 实体
    * 实体：任何可发生或接受信息的硬件或软件进程
    * 对等实体：收发双方相同层次中的实体

    ![图片](images/Screenshot%202023-06-24%20153813.png)
  * 协议
    * 协议：控制两个对等实体进行逻辑通信的规则的集合

      ![图片](images/Screenshot%202023-06-24%20170257.png)
    * 语法：定义所交换信息的格式

      ![图片](images/Screenshot%202023-06-24%20170525.png)

    * 语义：定义收发双方所要完成的操作

      ![图片](images/Screenshot%202023-06-24%20170525.png)

    * 同步：定义收发双方的时序关系

      ![图片](images/Screenshot%202023-06-24%20170959.png)

  * 服务
    * 服务：在协议的控制下，两个对等实体间的逻辑通信使得本层能够向上一层提供服务
    * 要实现本层协议，还需要使用下面一层所提供的服务
    * 实体看得见相邻下层所提供的服务，但并不知道实现该服务的具体协议。下面的协议对上面实体是“透明的”
    * 服务访问点：在同一系统中相邻两层的实体交换信息的逻辑接口，用于区分不同的服务类型
    * 服务源语：上层使用下层所提供的服务必须通过与下层交换一些命令，这些命令叫做服务源语
    * 协议服务单元PDU 对等实体之间传输的数据包称为协议服务单元PDU
    * 服务数据单元SDU 同一系统内，层与层之间交换的数据包称为服务数据单元SDU

    ![图片](images/Screenshot%202023-06-24%20173045.png)

## 物理层

### 物理层的基本概念

* 传输媒体
  * 导引型传输媒体
    * 双绞线
    * 同轴电缆
    * 光纤
  * 非导引型传输媒体
    * 微波通信(WIFI)(2~40GHz)

* 物理层协议的主要任务
  * 机械特性
    * 指明接口所用接线器的形装和尺寸、引脚数目和排列、固定和锁定装置
  * 电气特性
    * 指明在接口电缆的各条线上出现的电压范围
  * 功能特性
    * 指明某条线上出现某一电平的电压表示各种意义
  * 过程特性
    * 指明对于不同功能的各种可能事件的出现顺序

### 物理层下面的传输媒体

* 导引型传输媒体
  * 同轴电缆

    ![图片](images/Screenshot%202023-06-25%20105834.png)

    * 基带同轴电缆
      数字传输，过去用于局域网
    * 宽带同轴电缆
      模拟传输，目前主要用于有线电视
  
    同轴电缆价格较贵且布线不够灵活和方便，随着集线器的出现，在局域网领域基本采用双绞线做传输媒体

  * 双绞线

    ![图片](images/Screenshot%202023-06-25%20110250.png)

  * 光纤

    ![图片](images/Screenshot%202023-06-25%20110519.png)

    ![图片](images/Screenshot%202023-06-25%20110705.png)

    ![图片](images/Screenshot%202023-06-25%20110900.png)

  * 电力线

    ![图片](images/Screenshot%202023-06-25%20111016.png)

* 非导引型传输媒体
  
![图片](images/Screenshot%202023-06-25%20111335.png)

* 微波
  * 卫星通信
  * 地面微波接力通信

* 红外线

  ![图片](images/Screenshot%202023-06-25%20111915.png)
* 可见光
  * 实验阶段

### 传输方式

* 串行传输：一次发送一个比特，需要一条传输线路
  * 计算机网络中采取串行传输
* 并行传输：一次发送N个比特，需要N条传输线路
  * 计算机内部采取并行传输

![图片](images/Screenshot%202023-06-25%20135842.png)

* 同步传输
* 异步传输
![图片](images/Screenshot%202023-06-25%20140150.png)

* 单向通信(单工)
* 双向交替通信(半双工)
* 双向同时通信(全双工)
![图片](images/Screenshot%202023-06-25%20140528.png)

### 编码与调制

![图片](images/Screenshot%202023-06-25%20142444.png)

* 编码

![图片](images/Screenshot%202023-06-25%20142624.png)

* 调制

![图片](images/Screenshot%202023-06-25%20142814.png)
![图片](images/Screenshot%202023-06-25%20142902.png)

### 信道的极限容量

* 奈氏准则

![图片](images/Screenshot%202023-06-25%20143434.png)

* 香农公式

![图片](images/Screenshot%202023-06-25%20143624.png)

## 数据链路层

### 数据链路层概述

![图片](images/Screenshot%202023-06-25%20154739.png)

* 使用点对点信道的数据链路层

  * 封装成帧
    ![图片](images/Screenshot%202023-06-25%20155005.png)

  * 差错检测
    ![图片](images/Screenshot%202023-06-25%20155227.png)
    ![图片](images/Screenshot%202023-06-25%20155242.png)

  * 可靠传输
    ![图片](images/Screenshot%202023-06-25%20155457.png)

* 使用广播信道的数据链路层

  ![图片](images/Screenshot%202023-06-25%20160046.png)
* 数据链路层的互联设备

  ![图片](images/Screenshot%202023-06-25%20160144.png)

### 封装成帧

* 封装成帧是指数据链路层给上层交付的协议数据单元添加帧头帧尾使之成为帧
  * 帧头和帧尾中包含有重要的控制信息
    ![图片](images/Screenshot%202023-06-25%20161911.png)
  * 帧头和帧尾的作用之一就是帧定界
    * 区别上一个帧和下一个帧
     ![图片](images/Screenshot%202023-06-25%20161614.png)

* 透明传输是指数据链路层对上层交付传输的数据没有任何限制，就好像数据链路层不存在一样
  * 面向字节的物理链路使用字节填充(或成字符填充)的方式实现透明传输
    ![图片](images/Screenshot%202023-06-25%20163203.png)
  * 面向比特的物理链路使用比特填充的方式实现透明传输
    每五个1后面就插入一个0，读取的时候就去掉0  
    ![图片](images/Screenshot%202023-06-25%20162830.png)

* 为了提高帧的传输速率，应当使帧的数据部分的长度尽可能大些
* 考虑到差错控制等诸多因素，每一种数据链路层协议都帧的数据部分的长度限制，即最大传送单元MTU

### 差错检测

* 实际的通信连路都不是理想的，比特在传输过程中也可能产生差错：1可能变成0。这称为比特差错
* 在一段时间内，传输错误的比特占所传输比特总数的比率称为误码率(Bit Error Rate)
* 使用差错检验码来检测数据在传输过程中是否产生了比特差错，是数据链路层谁要解决的重要问题

![图片](images/Screenshot%202023-06-25%20165350.png)

* 奇偶校验
  * 在待发送的数据后面添加1位奇偶位，使整个数据(包含添加的校验位在内)中的“1”的个数为奇术(奇校验)或偶数(偶校验)

  ![图片](images/Screenshot%202023-06-25%20165955.png)

* 循环冗余校验CRC(Cyclic Redundancy Check)
  ![图片](images/Screenshot%202023-06-25%20170407.png)
  ![图片](images/Screenshot%202023-06-25%20171931.png)
  ![图片](images/Screenshot%202023-06-25%20171846.png)

* 检错码只能检测出帧在传输过程中出现了差错，但不能定位差错，因此无法纠正错误
* 要想纠正传输过程中的错误，可以使用冗余信息更多的纠错码进行前向纠错。但纠错码的开销比较大，在计算机网络中较少使用
* 循环冗余校验CRC有很好的验错能力(漏检率非常低)，虽然计算比较复杂，但非常易于硬件实现，因此被广泛引用于数据链路层
* 在计算机网络中通常采取后续课程中的方法来纠正错误或者丢弃出错的帧，这取决于数据链路层向上层提供的是可靠还是不可靠服务

### 可靠传输

### 可靠传输的基本概念

* 使用差错检测技术(例如循环冗余检测CRC)，接收方的数据链路层就可检测出帧在传输过程中是否产生了误码(比特错误)
* 数据链路层向上层提供的服务类型
  * 不可靠传输服务：仅仅丢弃有误码的帧，其他什么也不做
  * 可靠传输服务：想办法实现发送端发送什么，接收端就收到什么
* 一般情况下，有线链路的误码率比较低，为了减小开销，并不要求数据链路层向上提供可靠传输服务。即使出现了误码，可靠传输的问题由其送过来上层处理
* 无线路易受干扰，误码率比较高，因此要求数据链路层必须向上层提供可靠的传输服务。
* 比特差错只是传输差错中的一种
* 从整个计算机网络体系结构来看，传输差错还包括分组丢失，分组失序以及分组重复。
* 分组丢失，分组失序以及分组重复这些传输差错，一般不会出现在数据链路层，而会出现在其上层。
* 可靠传输服务并不仅局限于数据链路层，其他过程均可使选择实现可靠传输
![图片](images/Screenshot%202023-06-26%20134246.png)

* 可靠传输的实现比较复杂，开销也比较大，是否使用可靠传输取决于应用的需求。

### 可靠传输的实现机制

* 停止-等待协议SW

  ![图片](images/Screenshot%202023-06-27%20100028.png)
  ![图片](images/Screenshot%202023-06-27%20100730.png)
  ![图片](images/Screenshot%202023-06-27%20100632.png)

  **注意事项**
  * 接收端检测到数据分组有误码时，将其丢弃并等待发送方的超时重传。但对误码率较高的点对点链路时，为使发送方尽早重传，也可给发送方发送NAK分组。
  * 为了让接收方能够判断所收到的数据分组是否重复，需要给数据分组编号。由于停止等待协议的停等特性，需要一个比特编号就够了，及编号0和1。
  * 为了让发送方能够判断所收到的ACk分组是否是重复的，需要给ACK分组编号，所用比特数量与数据分组编号所用比特数量一样。数据链路层一般不会出现ACk分组迟到的情况，因此在数据链路层实施停止-等待协议可以不用给分组编号
  * 设置的重传时间应仔细选择。一般可将重传时间选为略大于从发送方到接收方的平均往返时间。
    * 在数据链路层点对点的往返时间比较确定，重传时间比较好设定。
    * 然而在运输层，由于端到端往返时间非常不确定，设置合适的重传时间有时并不容易。
  * 信道利用率

  ![图片](images/Screenshot%202023-06-27%20104021.png)

* 回退N帧协议GBN

  ![图片](images/Screenshot%202023-06-28%20114339.png)
  ![图片](images/Screenshot%202023-06-28%20114638.png)
  ![图片](images/Screenshot%202023-06-28%20114821.png)
  ![图片](images/Screenshot%202023-06-28%20115814.png)
  * 回退N帧协议在流水线上传输的基础利用发送窗口来限制发送方连续发送数据分组的数量，是一种连续的ARQ协议
  * 协议的工作过程中发送窗口和接受窗口不断向前滑动，因此这类协议又被称为滑动窗口协议
  * 由于回退N帧协议的特性，当通信线路质量不好时，其信道利用率并不比停止-等待协议高。

* 选择重传协议

  ![图片](images/Screenshot%202023-06-28%20120810.png)

  ![图片](images/Screenshot%202023-06-28%20122944.png)

  **发送和接受窗口大于取值范围**

  ![图片](images/Screenshot%202023-06-28%20122753.png)
  ![图片](images/Screenshot%202023-06-28%20122658.png)

* 这三种可靠传输实现的机的基本原理并不仅限于数据链路层，可以应用到计算机网络体系结构的各层协议中

### 点对点协议PPP

* 点对点协议PPP(Point-to-Point Protocol)是目前使用最广泛的点对点数据链路层协议
* PPP协议是因特网工程组IEFT在1992年制定的。经过1993年和1994年的修订，现在PPP协议 已成为因特网的正式标准[RFC1661,RFC1662]
* PPP协议为在点对点链路传输各种协议数据提供了一个标准方法，主要有以下三部分构成：
  * 对各种协议数据报的封装方法(封装成帧)
  * 链路控制协议LCP 用于建立、配置以及测试数据链路的链接
  * 一套网络控制协议NCPs 其中的每一个协议支持不同的网络层协议
  ![图片](images/Screenshot%202023-06-28%20151228.png)

* 帧格式

![图片](images/Screenshot%202023-06-28%20151601.png)

* 透明传输

异步传输
![图片](images/Screenshot%202023-06-28%20152000.png)
同步传输
![图片](images/Screenshot%202023-06-28%20152212.png)

* 差错检测

![图片](images/Screenshot%202023-06-28%20152555.png)

* 工作状态

![图片](images/Screenshot%202023-06-28%20152806.png)

### 媒体接入控制

* 媒体接入控制的基本概念

* 共享信道要着重考虑的一个问题就是如何协调多个发送和接收点对一个共享传输媒体的占用，即媒体接入控制MAC(Medium Access Control)
![图片](images/Screenshot%202023-06-28%20163812.png)

* 媒体接入控制——静态划分信道

信道复用

* 复用(Multiplexing)是通信技术中的一个重要概念。复用就是通过一条物理链路同时传输多路用户的信号
* 当网络中传输媒体的传输容量大于多条单一信道传输的总通信量时，可以用复用技术在一条物理链路上建立多条信道来充分利用传输媒体的带宽
  ![图片](images/Screenshot%202023-06-28%20164839.png)
  * 频分复用FDM
    ![图片](images/Screenshot%202023-06-28%20165039.png)
  * 时分复用TDM
    ![图片](images/Screenshot%202023-06-28%20165345.png)
  * 波分复用WDM
    ![图片](images/Screenshot%202023-06-28%20165632.png)
  * 码分复用CDM
  * 码分复用CDM时另一种共享信道的方法。实际上，由于该技术主要用于多址接入，人们更常用的名词是码分多址CDMA(Code Divison Multiple Access)
  * 同理，频分复用FDM、时分复用TDM同样可用于多址接入，相应的名词是频分多址FDMA和时分多址TDMA
  * 在本课中我们不严格区分复用和多址的概念。可简单理解如下
    * 复用是将单一媒体的频带资源划分成许多子信道，这些子信道之间相互独立、互不干扰。从媒体的整体频道资源上看，每个子信道只占用媒体频道资源的一部分
    * 多址（更准确叫多点接入）处理的是动态分配信道给用户。这在用户仅仅暂时的占用信道的应用中是必须的，而所用的移动通信系统基本上都处于这种情况。相反，在信道永久性的分配给用户的应用中，多址是不需要的（对于无线广播和电视广播站就是这样）
    * 与频分复用和时分复用不同码分复用的每一个用户可以在同样的时间使用同样的频带进行通信
    * 由于各用户使用特殊挑选的不同码型，因此各用户之间不会造成干扰
    * CDM最早用于军事通信，因为这种系统所发送的信号有很强的抗干扰能力，其频谱类似于白噪声，不易被敌人发现
    * 随着技术的进步，CDMA设备的价格和体积都大幅下降，因而现在已经广泛的用于民用移动通信
    * 在CDMA中，每一个比特时间再划分为m个短间隔称为码片（Chip）。通常m的值是64或128
    * 使用CDMA的每一个站被指派一个唯一的m bit码片序列（Chip Sequence）
      * 一个站如果要发送比特1，则发送他自己的m bit码片序列
      * 一个站如果要发送比特0，则发送他自己的m bit码片序列的二进制反码
      ![图片](images/Screenshot%202023-06-28%20185559.png)
    * 码片序列的挑选原则如下：
      1. 分配给每个站的码片序列必须各不相同，实际常采用伪随机码序列
      2. 分配给每个站的码片序列必须相互正交（规格化内积为0）
      ![图片](images/Screenshot%202023-06-28%20190414.png)
      例题
      ![图片](images/Screenshot%202023-06-28%20190625.png)
    * 应用举例
    ![图片](images/Screenshot%202023-06-28%20191032.png)

媒体接入控制——动态接入控制——随机接入

载波监听多址接入/碰撞检测 CDMA/CD
![图片](images/Screenshot%202023-06-28%20191710.png)
![图片](images/Screenshot%202023-06-28%20192013.png)
![图片](images/Screenshot%202023-06-28%20192241.png)

* CSMA/CD/协议————征用期（碰撞窗口）
  ![图片](images/屏幕截图%202023-07-01%20102705.png)
  
* CSMA/CD/协议————最小帧长

  ![图片](images/屏幕截图%202023-07-01%20103242.png)

* CSMA/CD/协议————最大帧长
  ![图片](images/屏幕截图%202023-07-01%20103527.png)

* CSMA/CD/协议————截断二进制指数退避算法
  ![图片](images/屏幕截图%202023-07-01%20103801.png)

* CSMA/CD/协议————信道利用率

  ![图片](images/屏幕截图%202023-07-01%20104230.png)

* CSMA/CD/协议————帧发送流程  
  ![图片](images/屏幕截图%202023-07-01%20104406.png)
* CSMA/CD/协议————帧接受流程
  ![图片](images/屏幕截图%202023-07-01%20104549.png)

载波监听多址接入/碰撞避免 CDMA/CA

![图片](images/屏幕截图%202023-07-01%20105947.png)

* 802.11无线局域网使用CDMA/CA协议，在CDMA的基础上增加了一个碰撞避免CA功能，而不在实现碰撞检测功能
* 由于不可避免所有碰撞，并且无线信道误码率较高，802.11标准还使用了数据链路层确认机制（停止-等待协议）来保证数据被正确接受
* 802.11的MAC层标准定义了两种不同的媒体接入控制方式
  * 分布式协调功能DCF（）在DCF方式下，没有中心控制站点，每个站点使用CDMA/CA协议通过争用信道来获取发送权，这是802.11定义的默认方式
  * 点协调功能PCF（）PCF方法使用集中控制的接入算法（一般在接入点AP实现集中控制），是802.11定义的可选方法，在实际中较少使用

帧间间隔IFS（）

* 802.11标准规定，所有的站点必须在持续检测到信道空闲一段时间后才能发送帧，这段时间称为帧间间隔IFS
* 帧间间隔的长短取决于该站点需要发送的帧类型
  * 高优先级的帧所需要等待的时间较短，因此可优先获得发送权
  * 低优先级的帧所需要等待的时间较长，若某个站点的低优先级帧还没来得及发送，而其他站的高优先级帧以发送到信道上，则信道变为忙态，因而低优先级帧只能推迟发送。这样就减少了发生碰黄的机会
* 常用的两种帧间间隔
  * 短帧间间隔SIFS（），是最短的帧间间隔，用来分隔开属于一次对话的各帧。一个站点应当能在在段时间内从发送切换到接受。使用SIFS的帧类型有ACK帧、CTS帧、由过长的MAC帧分片后的数据帧、以及所有回答AP探寻的帧和在PCF方式中接入点AP发送的任何帧
  * DCF帧间间隔DIFS（），它比短帧间间隔SIFS要长得多在DCF方式中用来发送数据帧和管理帧

载波监听多址接入/碰撞避免 CDMA/CA协议的工作原理

![图片](images/屏幕截图%202023-07-04%20181340.png)
![图片](images/屏幕截图%202023-07-04%20181544.png)
![图片](images/屏幕截图%202023-07-04%20181648.png)

* 当站点检测到信道是空闲的，并且所发送的数据帧不是成功发送完上一个数据帧之后立即发送的数据帧，则不使用退避算法
* 以下情况下必须使用退避算法
  * 在发送数据帧之前检测到信道处于忙状态时
  * 在每一次重传一个数据帧时
  * 在每一次成功发送后要连续发送下一个帧时（这是为了避免一个站点长时间占用信道）

载波监听多址接入/碰撞避免 CDMA/CA协议的退避算法

* 在执行退避算法时，站点为退避计时器设置一个随机的退避时间
  * 当退避计时器的时间减小到零时，就开始发送数据
  * 当退避计时器的时间还未减小到零时而信道又转变为忙状态，这时就冻结退避计时器的数值，重新等待信道变为空闲，在经过时间DIFS后，继续启动这个退避计时器
* 在进行第i次退避时，退避时间在时隙编号{0,1,2,...,2^2+i^-1} 中随机选择一个，然后乘以基本退避时间（也就是一个时隙的长度）就可以得到随机的退避时间。这样做是为了使不同站点选择相同的退避时间的概率减少了。当时隙编号达到255（对应第六次退避）时就不在增加了

![图片](images/屏幕截图%202023-07-04%20183826.png)

载波监听多址接入/碰撞避免 CDMA/CA协议的信道预约和虚拟载波监听

* 为了尽可能减少碰撞的概率和降低碰撞的影响，802.11标准允许要发送数据的站点对信道进行预约
  1. 源站在发送数据帧之前先发送一个短的控制帧，称为请求发送RTS（），它包括源地址，目的地址以及这次通信（包括相应的确认帧）所需的持续时间
  2. 若目的站正确收到源站发送的RTS帧，且媒体空闲，就发送一个相应控制帧，称为允许发送CTS，它也包括这次通信所需的持续时间（从RTS中将此次时间复制到CTS）
  3. 源站收到CTS帧后，在经过一段时间SIFS后，就可发送其数据帧
  4. 若目的站正确的收到源站发来的数据帧，在等待时间SIFS后，就向源站发送确认帧ACK
* 除原站和目的站以外的替他各站，在收到CTS帧（或数据帧）后就推迟接入到无线局域网中。这样就保证了原站和目的站之间的通信不会受到其他站的干扰。
* 如果RTS帧发生碰撞，源站就收不到CTS帧，需执行退避算法重传RTS帧。
* 由于RTS帧和CTS帧很短，发送碰撞的概率，碰撞产生的开销及本身的开销都很小。而对于一般的数据帧，其发送时延往往大于传播时延（因为是局域网），碰撞的概率很大，一旦发生碰撞而导致数据帧重发，则浪费的时间就很多，因此用很小的代价对信道进行预约往往是值得的。802.11标准规定了3种情况供用户选择
  * 使用RTS和CTS帧
  * 不使用RTS和CTS帧
  * 只有当数据帧的长度超过某一数值时才使用RTS和CTS帧

![图片](images/屏幕截图%202023-07-05%20145854.png)

* 除RTS帧和CTS帧会携带通信信道需要的持续时间，这称为802.11的虚拟载波监听机制
* 由于利用虚拟载波监听机制，站点只需要就是监听到RTS是帧，CTS帧或数据帧中的任何一个，就知道信道被占用的持续时间，而不是真正监听到信道上的信号，因此虚拟载波监听机制能减少隐蔽站带来的碰撞问题
![图片](images/屏幕截图%202023-07-05%20145449.png)

### MAC地址、IP地址以及ARP协议

* MAC地址是以太网的MAC子层所使用的地址 --数据链路层
* IP地址是TCP/IP体系结构网际层所使用的地址
* ARP协议属于TCP/IP体系结构的网际层，其作用是已知设备所分配到的IP地址的，使用ARP协议可以通过该IP地址获取到设备的MAC地址
* 尽管IP地址和ARP协议属于TCP/IP体系结构的网际层（而不属于数据链路层），但他们与MAC地址存在一定的关系，并且我们日常的网络应用都离不开MAC地址，IP地址以及ARP协议。因此我们一起讨论

MAC地址

使用点对点信道的数据链路层不需要使用地址

* 当多个主机连接在同一个广播信道上，想要实现两个主机之间的通信，则每个主机都必须有一个唯一标识，即一个数据链路层地址
* 在每个主机发送的帧中必须携带标识发送主机和接收主机的地址。由于这类地址是用于媒体介入控制MAC（），因此这类地址被称为MAC地址
  * MAC地址一般被固化在网卡（网络适配器）的电可擦可编程只读存储器EEPROM中，因此MAC地址也被称为硬件地址
  * MAC地址有时也被称为物理地址
![图片](images/屏幕截图%202023-07-05%20172658.png)
![图片](images/屏幕截图%202023-07-05%20173020.png)

* 一般情况下，用户主机会包含两个网络适配器：有线局域网适配器（有线网卡）和无线局域网适配器（无线网卡）。每个网络适配器都有一个全球唯一的MAC地址。而交换机和路由器往往拥有更多的网络接口，所以会有更多的MAC地址。严格来说，MAC地址是对网络各个接口的唯一标识，而不是对网络上各设备的唯一标识

IEEE 802局域网的MAC地址格式

![图片](images/屏幕截图%202023-07-05%20175328.png)
![图片](images/屏幕截图%202023-07-05%20175445.png)
![图片](images/屏幕截图%202023-07-05%20175636.png)
![图片](images/屏幕截图%202023-07-05%20175805.png)
![图片](images/屏幕截图%202023-07-05%20180118.png)
*给主机配置多播组列表进行私有应用时，不得使用公有的标准多播地址*

随机MAC地址

    防追踪

IP地址

* IP地址是因特网（Internet）上的主机和路由器所使用的地址，用于标识两部分信息：
  * 网络编号：表示因特网上数以百万计的网络
  * 主机编号：表示同一网络上不同主机（或路由器各接口）
* 很显然MAC地址不具备区分不同网络的功能
  * 如果只是一个单独的网络，不介入因特网，可以只使用MAC地址（这不是一般用户的应用方式）
  * 如果主机所在的网络要接入因特网，则IP地址的MAC地址都需要使用
![图片](images/屏幕截图%202023-07-05%20190459.png)

![图片](images/屏幕截图%202023-07-05%20190801.png)

数据包转发过程中IP地址与MAC地址的变化情况

![图片](images/屏幕截图%202023-07-05%20191205.png)

* 数据包转发过程中源IP地址和目的IP地址保持不变
* 数据包转发过程中源MAC地址和目的MAC地址逐个链路（或逐个网络）改变

**ARP(地址解析协议)**

![图片](images/屏幕截图%202023-07-05%20212830.png)
![图片](images/屏幕截图%202023-07-05%20212922.png)
![图片](images/屏幕截图%202023-07-05%20213014.png)
![图片](images/屏幕截图%202023-07-05%20213051.png)
![图片](images/屏幕截图%202023-07-05%20213122.png)
![图片](images/屏幕截图%202023-07-05%20213156.png)

### 集线器和交换机的区别

* 早期总线型以太网
![图片](images/屏幕截图%202023-07-06%20154212.png)

* 使用双绞线和集线器HUB的星形以太网
  * 使用集线器的以太网在逻辑上依然是一个总线网，各站共享总线资源，使用CSMA/CD协议
  * 集线器只工作在物理层，他的每个接口仅简单的转发比特，不进行碰撞检测（由各站的网卡检测）。
  * 集线器一般都有少量的容错能力和网络管理功能。例如，若网络中某个网卡出现故障，不停地发送帧。此时，集线器可以检测到这个故障，在内部断开与故障网卡的连线，使整个以太网可以正常工作
  ![图片](images/屏幕截图%202023-07-06%20161506.png)

* 使用集线器HUB在物理层扩展以太网
![图片](images/屏幕截图%202023-07-06%20161810.png)

* 以太网交换机
  * 以太网交换机通常都有多个接口。每个接口都可以与一台主机或另一个以太网交换机相连。一般都工作在全双工模式
  * 以太网交换机具有并行性，能同时联通多对接口，使多对主机能同时通信，无碰撞（不使用CSMA/CD协议）
  * 以太网交换机一般都具有多种速率的接口。例如：10Mb/s、100Mb/s等
  * 以太网交换机工作在数据链路层（也包括物理层），它收到帧后，在帧交换表中查找帧的目的MAC地址对应的接口号，然后通过该接口转发帧
  * 以太网交换机是一种即插即用的设备，其内部的帧交换表是通过自学习算法自动的逐步建立起来的
  * 帧的两种转发方式
    * 储存转发
    * 直通交换：采用基于硬件的交换矩阵（交换时延非常小，不检查帧是否有差错）
![图片](images/屏幕截图%202023-07-06%20162008.png)
![图片](images/屏幕截图%202023-07-06%20163244.png)

* 对比集线器和交换机
![图片](images/屏幕截图%202023-07-06%20164212.png)

### 以太网交换机自学习和转发帧的流程

* 以太网交换机工作在数据链路层（也包括物理层）
* 以太网交换机收到帧后，在帧交换表中查找帧的目的MAC地址所对应的接口号，然后通过该接口转发帧
* 以太网交换机是一种即插即用的设备，刚上电启动其内部的帧交换表是空的。随着网络中各主机的通信，以太网交换机通过自学习算法自动逐渐建立起帧交换表
![图片](images/屏幕截图%202023-07-06%20200900.png)
![图片](images/屏幕截图%202023-07-06%20200813.png)

### 以太网交换机生产树协议STP

* 添加冗余链路可以提高以太网的可靠性
* 但是冗余链路也会带来负面影响————形成网络环路
* 网络环路会带来以下问题
  * 广播风暴
    大量消耗网络资源，使得网络无法转发其他数据帧
  * 主机收到重复的广播帧
    大量消耗主机资源
  * 交换机的帧交换表震荡
  ![图片](images/屏幕截图%202023-07-06%20202419.png)

* 以太网交换机使用生产树协议（）可以在增加冗余链路来提高网络可靠性的同时又避免网络环路带来的问题
  * 不论交换机之间采用怎样的物理连接，交换机都能够自动计算并构建一个逻辑上没有环路的网络，其逻辑拓扑结构必须是树形的（无逻辑环路）
  * 最终生成的树形逻辑拓扑要保证联通整个网络
  * 当首次连接交换机或物理拓扑发送变化时（有可能是人为改变或故障），交换机都将重新进行生成树的计算
![图片](images/屏幕截图%202023-07-06%20203217.png)

### 虚拟局域网VLAN概述

* 以太网交换机工作在数据链路层（也包括物理层）
* 使用一个或多个以太网交换机互联起来的交换式以太网，其所有站点同属于一个广播域
* 随着交换式以太网规模的扩大，广播域相映的扩大
* 巨大的广播域会带来很多弊端
  * 广播风暴
  * 难以维护和管理
  * 潜在的安全问题
![图片](images/屏幕截图%202023-07-06%20220648.png)

* 网络中会频繁地出现广播信息
  * TCP/IP协议栈中很多协议都会使用广播
    * 地址解析协议ARP
    * 路由信息协议RIP
    * 动态主机配置协议DHCP
  * NetBEUI：Windows下使用的广播型协议
  * IPX/SPX：Novell网络的协议栈
  * Apple Talk：Apple公司的网络协议栈

* 分割广播域的方法
  * 使用路由器可以隔离广播域
     ![图片](images/屏幕截图%202023-07-06%20221317.png)
  * 虚拟局域网VLAN

* 虚拟局域网VLAN（）是一种将局域网内的设备划分为与物理位置无关的逻辑组技术，这些逻辑组具有某些共同的需求
![图片](images/屏幕截图%202023-07-06%20221533.png)

### 虚拟局域网VLAN的实现机制

IEEE 802.1Q帧

* IEEE 802.1Q帧（也称Dot One  Q帧）对以太网的MAC帧格式进行了拓展，插入了4字节的VLAN标记
* VLAN标记的最后12比特称为VLAN标识符VID，它唯一地标志了以太网帧属于哪一个VLAN
  * VID的取值范围是0 \~ 4095（0 \~ 2^12^-1）
  * 0和4095都不用来表示VLAN，因此用于表示VLAN的VID的有效取值范围是1 ~ 4094
* 802.1Q帧是由交换机处理的，而不是用户的主机来处理
  * 当交换机收到普通的以太网帧时，会将其插入4字节的VLAN标记转变为802.1Q帧，简称“打标签”
  * 当交换机转发802.1Q帧时，可能会删除其4字节的VLAN标记转变为普通的以太网帧，简称“去标签”
![图片](images/屏幕截图%202023-07-07%20144420.png)

交换机的端口类型

* 交换机的端口类型有以下三种
  * Access
  * Trunk
  * Hybrid
* 交换机个端口的缺省VLAN ID
  * 在思科交换机上称为Native VLAN，即本征VLAN
  * 在华为交换机上称为Port VLAN ID，即端口VLAN ID，简称为PVID

* Access
  * Access端口一般用于连接用户计算机
  * Access端口只能属于一个VLAN
  * Access端口的PVID值与端口所属的VLAN的ID相同（默认为1）
  * Access端口接受处理方法：一般只接受“未打标签”的普通以太网MAC帧。更具接受帧的端口的PVID给帧“打标签”，即插入4字节的VLAN标记字段，字段中的VID取值与端口的PVID取值相等
  * Access端口发送处理方法：若帧中的VID与端口的PVID相等，则“去标签”并转发该帧，否则不转发
  
![图片](images/屏幕截图%202023-07-07%20145940.png)
![图片](images/屏幕截图%202023-07-07%20145845.png)

* Trunk
  * Trunk端口一般用于交换机之间或交换机与路由器之间的互联
  * Trunk端口可以属于多个VLAN
  * 用户可以设置Trunk端口的PVID值。默认情况下Trunk端口的PVID值为1
  
  * Trunk端口接受处理方法：
    * 接受“未打标签”的帧，更具接受帧的端口的PVID给帧“打标签”，即插入4字节的VLAN标记字段，字段中的VID取值与端口的PVID取值相等
    * 接受已打标签的帧

![图片](images/屏幕截图%202023-07-07%20150859.png)
![图片](images/屏幕截图%202023-07-07%20151210.png)

* Hybrid
  * Hybrid端口即可用于交换机之间或交换机与路由器之间的互联（同Trunk接口），也可用于交换机连接用户计算机（同Access端口）
  * Hybrid端口可以属于多个VLAN（同Trun端口）
  * 用户可以设置Hybrid端口的PVID值。默认情况下Trunk端口的PVID值为1
  * Hybrid端口发送处理方法查看帧的VID是否在端口的“去标签”列表中
    * 若存在，“去标签”再转发
    * 若不存在，直接转发
  * Hybrid端口接受处理方法（同Trun端口）
    * 接受“未打标签”的帧，更具接受帧的端口的PVID给帧“打标签”，即插入4字节的VLAN标记字段，字段中的VID取值与端口的PVID取值相等
    * 接受已打标签的帧

![图片](images/屏幕截图%202023-07-07%20152259.png)
![图片](images/屏幕截图%202023-07-07%20152150.png)

## 网络层

### 4.1 网络层概述

* 网络层的主要任务是实现互联，进而实现数据包在各网络之间的传输
* 要实现网络层任务，要解决以下问题
  * 网络层向上层提供怎样的服务（“可靠传输”还是“不可靠传输”）
  * 网络层寻址问题
  * 路由选择问题
* 因特网（Internet）是目前全世界用户数量最多的互联网，它使用TCP/IP协议栈
* 由于TCP/IP协议栈的网络层使用网际协议IP，他是整个协议栈的核心协议。因此在TCP/IP协议栈网络层常称为网际层

### 4.2 网络层提供的两种服务

面相连接的虚电路服务

* 可靠通信由网络来保证
* 必须建立网络层的连接————虚电路VC（）
* 通信双方沿着已建立的虚电路发送分组
* 目的主机的地址仅在建立连接阶段使用，之后每个分组的首部只需要携带一条虚电路编号（构成虚电路的每一段链路都有一个虚电路编号）
* 这种通信方式如果在使用可靠传输的网络协议，就可使所发送的分组最终正确达到接收方（无差错按序到达、不丢失，不重复）
* 通信结束后，需要释放之前所建立的虚电路
* 很多广域分组交换网都使用面向连接的虚电路服务。如之前的X.25和逐渐过时的帧中继FR、异步传输模式ATM等

无连接的数据报服务

* 可靠通信应当由用户主机来保证
* 不需要建立网络层连接
* 每个分组可走不同路径
* 每个分组的首部必须携带目的主机的完整地址
* 这种通信方式所传输的分组可能误码，丢失，重复和失序
* 由于网络本身不提供端到端的可靠传输服务，这就使网络中的路由器可以做的比较简单，而且价格低廉（与电信网交换机相比较）
* 因特网采用了这种设计思想，也就是将复杂的网络处理功能至于因特网的边缘（用户主机和其内部运输层），而将相对简单的尽最大努力的分组交付功能置于因特网核心

### 4.3 IPv4

IPv4地址概述

* 在TCP/IP体系中，IP地址是一个最基本的概念
* IPv4就是给因特网上的每一个主机（或路由器）的每一个接口分配一个在全世界范围内是唯一的32比特标识符
* IP地址由因特网名字和数字分配机构ICANN（）进行分配
* 我国用户可向亚太网络信息中心APNIC（）申请IP地址，需要缴费
* 2011年2月3日，互联网号码分配管理局IANA（由ICANN行使职能）宣布，IPv4地址已经分配完毕
* 我国在2014至2015年也逐步的停止了向新用户和应用分配IPv4地址。同时全面开展商用部署IPv6
* IPv4地址的编织方式经历了以下三个阶段
![图片](images/屏幕截图%202023-07-07%20183331.png)

* 32比特的IPv4地址不方便阅读，记录以及输入等，因此IPv4地址采用点份十进制表示方法以便用户使用

![图片](images/屏幕截图%202023-07-07%20183700.png)

分类编址的IPv4地址

![图片](images/屏幕截图%202023-07-07%20184228.png)
![图片](images/屏幕截图%202023-07-08%20120452.png)
![图片](images/屏幕截图%202023-07-08%20121702.png)
![图片](images/屏幕截图%202023-07-08%20122019.png)
![图片](images/屏幕截图%202023-07-08%20122840.png)

划分子网的IPv4地址

* 32比特的子网掩码可以表示分类的IP地址的主机号被借用了几个比特作为子网号
  * 子网掩码使用连续的比特1来对应子网号和网络号
  * 子网掩码使用连续的比特0来对应主机号
  * 将划分子网的IPv4地址与其相应的子网掩码进行逻辑与计算就可以得到IPv4地址所在的子网网络地址

![图片](images/屏幕截图%202023-07-08%20125609.png)
![图片](images/屏幕截图%202023-07-08%20122840.png)

* 默认的子网掩码是指在未划分子网的情况下使用的子网掩码

![图片](images/屏幕截图%202023-07-08%20125153.png)

无分类编址的IPv4地址

* 划分子网在一定程度上缓解了因特网在发展过程中遇到的困难，但是数量巨大的C类网因为其地址空间太小并没有得到充分使用，而因特网的IP地址仍在加速消耗，整个IPv4地址空间面领着全部耗尽的威胁
* 为此，因特网工程组IETF又提出了采用无分类编址的发放解决IP地址紧张的问题，同时又专门成立了IPv6工作组负责研究新版本IP以彻底解决IP地址耗尽的问题
* 1993年IETF发布了无分类路由选择CIDR（）的RFC文档：RFC 1517 \~ 1519和1520
  * CIDR消除了传统的A、B、C类地址以及划分子网的概念
  * CIDR可以更加有效地分配IPv4地址空间，并且可以在新的IPv6使用之前允许因特网的规模持续增长

* CIDR使用“斜线记法”，或称CIDR记法。即在IPv4地址后面加上斜线“/”，在斜线后面写明网络前缀所占的比特数量
* CIDR实际上是把网络前缀都相同的IP地址组成一个“CIDR地址块”
* 我们只要知道CIDR地址块中的任何一个地址，就可以知道该地址块的全部细节
  * 地址块的最小地址
  * 地址块的最大地址
  * 地址块中的地址数量
  * 地址块聚合某类网络（A、B、C类）的数量
  * 地址掩码（或称子网掩码）

![图片](images/屏幕截图%202023-07-08%20162313.png)

* 路由聚合（构造超网）
* 网络前缀越长，地址块越小，路由越具体
* 若路由器查表转发分组时发现有多条路由可选，则选择网络前缀最长的那条，这称为最长前缀匹配，因为这样的路由更具体
![图片](images/屏幕截图%202023-07-08%20163035.png)

IPv4地址的应用规划

* 定长的子网掩码FLSM

  ![图片](images/屏幕截图%202023-07-08%20164835.png)
  ![图片](images/屏幕截图%202023-07-08%20164718.png)
  ![图片](images/屏幕截图%202023-07-08%20164748.png)

* 变长的子网掩码FLSM

  ![图片](images/屏幕截图%202023-07-08%20165320.png)
  ![图片](images/屏幕截图%202023-07-08%20165935.png)
  ![图片](images/屏幕截图%202023-07-08%20170123.png)

### 4.4 IP数据报的发送和转发过程

* IP数据报的发送和转发过程包含以下两部分
  * 主机发送IP数据报
  * 路由器转发IP数据报
  ![图片](images/屏幕截图%202023-07-08%20173048.png )
  ![图片](images/屏幕截图%202023-07-08%20172640.png)
  ![图片](images/屏幕截图%202023-07-08%20172726.png)
  ![图片](images/屏幕截图%202023-07-08%20172806.png)
  ![图片](images/屏幕截图%202023-07-08%20172911.png)

### 4.5 静态路由配置及其可能产生的路由环路问题

* 静态路由配置是指用户或网络管理员使用路由器的相关命令给路由器人工配置路由表
  * 这种人工配置方式简单、开销小。但不能及时适应网络状态（流量、拓扑等）的变化
  * 一般只在小规模网络中采用
* 使用静态路由配置可能出现以下导致产生路由环路的错误
  * 配置错误
  * 聚合了不存在的网络
  * 网络故障

![图片](images/屏幕截图%202023-07-08%20174444.png)
![图片](images/屏幕截图%202023-07-08%20175017.png)
![图片](images/屏幕截图%202023-07-08%20175252.png)
![图片](images/屏幕截图%202023-07-08%20181144.png)
![图片](images/屏幕截图%202023-07-08%20181655.png)
![图片](images/屏幕截图%202023-07-08%20181850.png)
![图片](images/屏幕截图%202023-07-08%20182939.png)
![图片](images/屏幕截图%202023-07-08%20183143.png)
![图片](images/屏幕截图%202023-07-08%20183328.png)

### 4.6 路由选择选择协议概述

静态路由选择

* 由人工配置的网络路由，默认路由，特定主机路由，黑洞路由等都属于静态路由
* 这种人工配置方式简单，开销小。但不能及时适应网络状态（流量、拓扑等）的变化
* 一般只在小规模网络中采用

动态路由选择

* 路由器通过路由选择协议自动获取路由信息
* 比较复杂，开销大。能较好的适应网络状态的变化
* 适用于大型网络

因特网所采用的路由选择协议的主要特点

![图片](images/屏幕截图%202023-07-09%20164751.png)

* 因特网采用分层次的路由选择协议

  ![图片](images/屏幕截图%202023-07-09%20165025.png)

* 常见的路由选择协议

  ![图片](images/屏幕截图%202023-07-09%20165153.png)

* 路由器的基本结构

  ![图片](images/屏幕截图%202023-07-09%20165351.png)

路由协议RIP的基本工作原理

* 路由信息协议RIP（）是内部网关协议IGP中最先得到广泛应用的协议之一，其标准文档为RFC 1058
* RIP要求自治系统AS内的每一个路由器都要维护从他到AS中其他每一个网络的距离记录。这是一组距离，称为“距离向量D-V（）”
* RIP使用跳数（）作为度量（）来衡量到达目的网络的距离
  * 路由器到直连网络的举例定义为1
  * 路由器到非直连网络的距离定义为所经过的路由器数量加1
  * 允许一条路径最多只能包含15和路由器，“距离”等于16时相当于不可达。因此，RIP协议只适用于小型互联网
  * RIP认为好的路由就是“距离短”的路由，也就是所通过路由器数量最少的路由
  ![图片](images/屏幕截图%202023-07-09%20170702.png)
  * 当到达同一目的网络有多条“距离相等”的路由时，可以进行等价负载均衡（将所发送的数据均分到两条路由上）
  * RIP包含三个要点
    * 和谁交换信息 相邻的路由器
    * 交换什么信息 自己的路由表
    * 合适交换信息 周期性交换
  ![图片](images/屏幕截图%202023-07-09%20173747.png)
  ![图片](images/屏幕截图%202023-07-09%20174232.png)
  * RIP算法存在“坏消息传播慢”的问题
  * “坏消息传播慢”又称为环路路由或距离无穷计数的问题，这是距离向量算法的一个固有问题。可以采取多种措施减少该问题出现的频率或减小该问题带来的危害
    * 限制路径最大距离为15（16表示不可达）
    * 当路由表发生变化时就立即发送更新报文（即“触发更新”），而不是周期性的发送
    * 让路由器记录收到的某特定路由信息的接口，而不是让同一路由信息在通过此接口反方向传送（即“水平分割”）
    ![图片](images/屏幕截图%202023-07-09%20175230.png)

开放式最短路径优先OSFT的基本工作原理

* 开放式最短路径优先OSFT（），是为了克服RIP的缺点在1989年开发出来的
  * 开放，表明OSFT协议不是收某一厂家控制的，而是公开发表的
  * “最短路径优先”是因为使用了Dijkstra提出的最短路径算法SPF
* OSPF是基于链路状态的，而不是像RIP那样是基于距离向量的
* OSPF采用SPF算法计算路由，从算法上保证不会出现路由环路
* OSPF不限制网络规模，跟新效率高，收敛速度快
* 链路状态是指本路由器都和那些路由器相邻，以及相映链路的“代价”
  * “代价”用来表示费用、时延、距离、带宽等等、这些都是由网络管理人员决定的
  ![图片](images/屏幕截图%202023-07-10%20114728.png)
* OSPF相邻路由器之间通过交互问候（Hello）分组，建立和维护邻居关系
  ![图片](images/屏幕截图%202023-07-10%20115151.png)
* 使用OSPF的每个路由器都会产生链路状态通告LSA（）。LSA包含以下内容
  * 直连网络的链路状态信息
  * 邻居路由器的链路状态信息
* LSA被封装在链路状态更新分组LSU中，采用洪泛法发送
* 使用OSPF的每个路由器都有一个链路状态数据库LCDB，用于储存LSA
* 通过各路由器洪泛法发送封装有自己LSA的LSU分组，各路由器的LSDB最终将达到一致
  ![图片](images/屏幕截图%202023-07-10%20130650.png)
* 使用OSPF的路由器基于LSDB进行最短路径优先SPF计算，构建出各自到达其他路由器的最短路径，即构建各自的路由表
  ![图片](images/屏幕截图%202023-07-10%20131318.png)

* OSPF有以下五种分组
  1. 问候分组（Hello）：用来发现和维护邻居路由器的可达性
  2. 数据库描述分组（）：像邻居路由器给出自己的链路状态数据库中的所用链路状态项目的摘要信息
  3. 链路状态请求（）：向邻居路由器请求发送某些链路状态项目的详细信息
  4. 链路状态更新分组（）：路由器使用这种分组将其链路状态进行洪泛法送，即用洪泛法对全网更新链路状态
  5. 链路状态确认分组（）：这是对链路状态更新分组的确认分组
* OSPF的基本工作过程
  ![图片](images/屏幕截图%202023-07-10%20141001.png)
* OSPF在多点接入网络中路由器邻居关系的建立
  ![图片](images/屏幕截图%202023-07-10%20142813.png)
* 为了使OSPF能够用于规模很大的网络，OSPF把一个自治系统再划分为若干个更小的范围，叫做区域

边界网关协议BGP

* 因特网采用分层次的路由选择协议
* 内部网关协议IGP（例如RIP或OSPF）
  * 无需考虑自治系统外部其他方面的策略
  * 设法使系统在一个自治系统尽可能的从源网络到目的网络
* 外部网关协议EGP（例如边界网关协议BGP）
  * 在不同的自治系统中度量路由的代价（距离，带宽，费用等）可能不同。因此，对于自治系统之间的路由选择，使用“代价”作为度量来寻找最佳路由是不行的
  ![图片](images/屏幕截图%202023-07-10%20165210.png)
  * 自治系统之间的路由选择必须考虑相关策略（政治，经济，安全等）
  * BGP只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），而并非寻找一条最佳路由
  ![图片](images/屏幕截图%202023-07-10%20165642.png)
* 在配置BGP时，每一个自己系统的管理员要至少选择一个路由器作为该自治系统的“BGP发言人”
* 不同自治系统的BGP发言人需要交换路由信息，必须建立TCP连接，端口号为179
  * 在此TCP连接上交换BGP报文已建立BGP会话
  * 利用BGP会话交换路由信息（例如，增加新的路由）
  * 利用TCP连接交换路由信息的两个BGP发言人彼此称为对方的邻站（）或对等站（）
* BGP发言人除了运行BGP外，还必须运行自己所在的自治系统所使用的内部网关协议IGP
* BGP发言人交换网络可达性的信息（要到达某个网络所经历的一系列自治系统）
* 当BGP发言人互相交换了网络可达性的信息后，各BGP发言人就根据所采用的策略从收到的路由信息中找出达到各自治系统较好的路由，即构建出树形结构，不存在回路的自治系统连通图
  ![图片](images/屏幕截图%202023-07-10%20170623.png)
* BGP适用于多级结构的因特网
  ![图片](images/屏幕截图%202023-07-10%20170733.png)
* BGP-4有以下四种报文
  1. 打开报文（）：用来与相邻的另一个BGP发言人建立关系，使通信初始化
  2. 更新报文（）：用来通告某一路由的信息，以及列出要撤销的多条路由
  3. 保活报文（）：用来周期性的证实邻站的连通性
  4. 通知报文（）：用来发送检测到的差错

![图片](images/屏幕截图%202023-07-10%20171427.png)

### IPv4数据报的首部格式

![图片](images/屏幕截图%202023-07-10%20171924.png)

* 版本：占4比特，表示IP协议的版本
  通信双方使用的IP协议版本必须一致。目前广泛使用的IP协议版本号为4（即IPv4）
* 首部长度：占4比特，表示IP数据报首部的长度。该字段的取值以4字节为单位
  最小十进制取值为5，表示IP数据报首部只有20字节的固定部分
  最大十进制取值为15，表示IP数据报首部包含20字节的固定部分和最大40字节的可变部分

* 可选字段：长度在1字节到40字节不等。用来支持排错、测量及安全等措施
  可选字段增加了IP数据报的功能，但这同时使得IP数据报的长度是可变的，这样就增加了每一个路由器处理IP数据报的开销，实际上可选字段很少被使用

* 填充字段：确保首部的长度为4字节的整数倍。使用全0进行填充

* 区分服务字段：占8比特，用来获得更好的服务
  该字段在旧标准中叫服务类型，但实际上一直没有被使用过
  1998年，因特网工程任务组IETF把这个字段改名为区分服务
  利用该字段的不同数值可提供不同等级的服务质量
  只有在使用区分服务时，该字段才起作用。一般情况下不适用该字段

* 总长度：占16比特，表示IP数据报的总长度（首部+数据载荷）
  最大长度为十进制的65535，以字节为单位
  ![图片](images/屏幕截图%202023-07-10%20184816.png)
* 标识、标志、片偏移

  ![图片](images/屏幕截图%202023-07-10%20185613.png)
  ![图片](images/屏幕截图%202023-07-10%20185401.png)

* 生存时间TTL：占8比特，最初以秒为单位，最大生存周期为255秒；路由器转发IP数据报时，将IP数据报中该字段的值减去IP数据报在本路由器上所耗费的时间，若不为0就转发，否则就丢弃
  现在以“跳数”为单位，路由器转发IP数据报时，将IP数据报中该字段的值减1，若不为0就转发，否则就丢弃
  ![图片](images/屏幕截图%202023-07-10%20190321.png)

* 协议字段：占8比特，指明IPv4数据报的数据部分是何种协议的数据单元
  ![图片](images/屏幕截图%202023-07-10%20190547.png)

* 首部检验和：占16比特，用来检测首部在传输过程中是否出现差错。比CRC检验码简单，称为因特网检验和
  IP数据报每经过一个路由器，路由器都要重新计算首部检验和，因为某些字段（生成时间，标志，片偏移等）的取值可能会改变
  由于IP层本身并不提供可靠传输服务，并且计算首部检验和是一项耗费时间的操作，因此在IPv6中，路由器不再计算首部检验和，从而更快转发数据报

* 源IP地址和目的IP地址
  各站32比特，用来填写发送该IP数据报的源主机IP地址和接收该IP数据报的目的主机IP地址

### 网际控制报文协议ICMP

* 为了更有效的转发IP数据报和提高交付成功的机会，在网际层使用了网际控制报文协议ICMP（）
* 主机或路由器使用ICMP来发送差错报告报文和询问报文
* ICMP报文被封装在IP数据报中发送
* ICMP差错报告分为以下五种
  ![图片](images/屏幕截图%202023-07-10%20193427.png)
  ![图片](images/屏幕截图%202023-07-10%20193557.png)
  ![图片](images/屏幕截图%202023-07-10%20193645.png)
  ![图片](images/屏幕截图%202023-07-10%20193814.png)
  ![图片](images/屏幕截图%202023-07-10%20193915.png)
  ![图片](images/屏幕截图%202023-07-10%20194235.png)
  ![图片](images/屏幕截图%202023-07-10%20194345.png)

* 以下情况不应发送ICMP差错报告报文
  * 对ICMP差错报告报文不再发送ICMP差错报告报文
  * 对第一个分片的数据报片的所有后续数据报片都不发送ICMP差错报告报文
  * 对具有多播地址的数据报都不发送ICMP差错报告报文
  * 对具有特殊地址（如127.0.0.0或0.0.0.0）的数据报都不发送ICMP差错报告报文

* 常用的ICMP询问报文有以下两种
  * 会送请求和回答
    ICMP回送请求报文是由主机或路由器的目的主机发送的询问。
    收到此报文的主机必须给原主机或路由器发送ICMP回送回答报文。
    各种询问报文用来测试目的站是否可达以了解其有关状态。
  * 时间戳请求和回答。
    ICMP时间戳请求报文是请某个主机或路由器回答当前的日期和时间。
    在ICMP时间戳回答报文中有一个32位的字段，其中写入的整数代表从1900年1月1日起到当前时刻一共有多少秒。
    各种询问报文用来进行时钟同步和测量时间。

* ICMP应用举例
  * 分组网间探测PING
  ![图片](images/屏幕截图%202023-07-10%20195809.png)
  * 跟踪路由
  ![图片](images/屏幕截图%202023-07-10%20195942.png)
  ![图片](images/屏幕截图%202023-07-10%20200032.png)
  ![图片](images/屏幕截图%202023-07-10%20200327.png)
  ![图片](images/屏幕截图%202023-07-10%20200254.png)
  ![图片](images/屏幕截图%202023-07-10%20200213.png)

### 虚拟专用网VPN与网络地址转换NAT

虚拟专用网VPN（）

![图片](images/屏幕截图%202023-07-10%20201410.png)
![图片](images/屏幕截图%202023-07-10%20201551.png)
![图片](images/屏幕截图%202023-07-10%20201243.png)

网络地址转换NAT（）

虽然因特网采用了无分类编织方式来减缓IPv4地址空间耗尽的速度，但由于因特网用户数目的激增，特别是大量小型办公室网络和家庭网络接入不断增加，IPv4一直空间即将面临耗尽的危险，仍然没有被解除。
1994年提出了一种网络地址转换NAT的方式再次缓解了IPv4地址空间即将耗尽的问题。
NAT能使大量使用内部专用地址的专用网络用户共享少量外部全球地址来访问因特网上的主机和资源。

![图片](images/屏幕截图%202023-07-10%20202816.png)
![图片](images/屏幕截图%202023-07-10%20202908.png)
![图片](images/屏幕截图%202023-07-10%20202950.png)
![图片](images/屏幕截图%202023-07-10%20202301.png)
![图片](images/屏幕截图%202023-07-10%20203238.png)
![图片](images/屏幕截图%202023-07-10%20203202.png)

## 运输层

### 5.1 运输层概述

* 物理层，数据链路层以及网络层他们共同解决了将主机通过异构网络互联起来所面临问题，实现了主机到主机的通信。
* 但实际上在计算机网络中进行通信的真正实体是位于通信两端主机中的进程。
* 如何为运行在不同主机上的应用进程供职业的通信服务是运输层的任务，运输层协议又称端到端协议
![图片](images/屏幕截图%202023-07-10%20203919.png)

### 运输层端口号、复用与分用的概念

* 运行在计算机上的进程，使用进程标识符PID来标志
* 因特网上的计算机并不是使用统一的操作系统，不同的操作系统（Windows、linux、Mac OS）又使用不同格式的进程标识符。
* 为了使运行不同操作系统的计算机的应用进程之间能够进行网络通信，你必须使用统一的方法对TCP/IP体系的应用进程进行标识
* TCP/IP体系的运输层使用端口号来区分应用层的不同应用进程
  * 端口号使用16比特表示，取值范围0~65535
    * 熟知端口号：0~1023，LANA把这些端口号指派给了TCP/IP体系中最重要的一些应用协议。例如：FTP使用21/20，HTTP使用80，DNS使用53
    * 登记端口号：1024~49151，为没有熟知端口后的应用进程使用。使用这类端口号必须在LANA按照规定的手续登记，以防止重复。例如，Microsoft RDP 微软远程桌面使用的端口是3389
    * 短暂端口号：49152~65535，留给客户进行选择，暂时使用。当服务器进程收到客户进程的报文时，客户进程所使用的动态端口号。通信结束的后，这个端口号可供其他客户进程以后使用。
  * 端口号只具有本地意义，及端口号只是为了标识本计算机应用层中的各进程，在因特网中，不同计算机中的相同端口号是没有联系

* 是发送方的复用和接收方的分用

![图片](images/屏幕截图%202023-07-11%20114012.png)

* TCP/IP体系的应用层防用协议所使用的运输层熟知端口号
![图片](images/屏幕截图%202023-07-11%20114322.png)
![图片](images/屏幕截图%202023-07-11%20114731.png)

### 5.3 UDP和TCP的对比

![图片](images/屏幕截图%202023-07-11%20141134.png)
![图片](images/屏幕截图%202023-07-11%20141315.png)
![图片](images/屏幕截图%202023-07-11%20142015.png)
![图片](images/屏幕截图%202023-07-11%20142255.png)
![图片](images/屏幕截图%202023-07-11%20142445.png)

### TCP的流量控制

* 一般来说，我们总是希望数据传输的更快一些。
  * 那如果发送方把数据传输的过快，接收方就可能来不及接收，这就会造成数据的丢失。
* 所谓流量控制（）就是让发送方的发送速率不要太快，要让接收方来得及接收。
* 利用滑动窗口机制可以很方便的在tcp连接上实现对发送方的流量控制。
![图片](images/屏幕截图%202023-07-11%20143534.png)
![图片](images/屏幕截图%202023-07-11%20143654.png)
![图片](images/屏幕截图%202023-07-11%20143845.png)

### TCP的拥塞控制

* 在某段时间，若对网络中某一资源的需求超过了该资源所能提供的可用部分，网络性能就要变坏。这种情况叫做拥塞（）
  * 在网络中的链路容量（即带宽）、交换节点中的缓存和处理机等，都是网络的资源。
* 如果出现拥塞而不进行控制，整个网络的吞吐量将会随输入负荷的增大而下降
![图片](images/屏幕截图%202023-07-11%20152214.png)

下面介绍这四种拥塞控制算法的基本原理,假定以下条件

1. 数据是单方向传送，而另一个方向只传送确认
2. 接收方总是有足够大的缓存空间，因而发送方发送窗口的大小由网络的拥塞程度来决定
3. 以嗯最大报文段MSS的个数为讨论问题的单位，而不是以字节为单位

![图片](images/屏幕截图%202023-07-11%20152825.png)

* 发送方维护一个叫拥塞窗口cwnd的状态变量，其值取决于网络的拥塞程度，且动态变化
  * 拥塞窗口的维护原则：只要网络没有出现拥塞，拥塞窗口就再增大一些；但只要网络出现拥塞，拥塞窗口就减少一些
  * 判断出现网络拥塞的依据：没有按时收到应当到达确认报文（即发生超时重传）
* 发送方将拥塞窗口作为发送窗口swnd，即swnd=cwnd
* 维护一个慢开始门限ssthresh状态变量

  * 当cwnd < ssthresh时，使用慢开始算法
  * 当cwnd > ssthresh时，停止使用慢开始算法改用拥塞避免算法
  * 当cwnd = ssthresh时，既可以使用慢开始算法，也可以使用拥塞避免算法

![图片](images/屏幕截图%202023-07-11%20154312.png)
![图片](images/屏幕截图%202023-07-11%20154356.png)
![图片](images/屏幕截图%202023-07-11%20154431.png)
![图片](images/屏幕截图%202023-07-11%20154514.png)

* “慢开始”是指一开始向网络注入的报文段少，不是值拥塞窗口增长速度慢
* “拥塞避免”并非指能够完全避免拥塞，而是指在拥塞避免阶段将拥塞窗口控制为按线性规律增长，使网络比较不容易出现拥塞
* 慢开始和拥塞避免算法是1988年提出的TCP拥塞控制算法（TCP Tahoe版本）
* 1990又增加了两个新的拥塞控制算法（改进TCP的性能），这就是快重传和快恢复（TCP Reno版本）
  * 有时，特别报文段会在网络中丢失，但实际上网络并未发生拥塞
    * 这将导致发送方超时重传，并误认为网络发生了拥塞
    * 嗯你看发送方把拥塞窗口cwnd设置为最小值1，并错误的启动慢开始算法，而降低了传输效率
* 采用快重传算法可以让发送方尽早知道发生了个别报文段的丢失
* 所谓快重传，就是使发送方尽快进行重传，而不是超时重传计时器超时再重传
  * 要求接收方不要等待自己发送数据时才进行捎带确认，而是要立即发送确认
  * 即使收到了失去的报文段也要立即发送对已收到的报文段的重复确认
  * 发送方一旦收到三个连续的重复确认，就将相应的报文段立即重传，而不是等该报文段的超时重传计时器超时再重传
  * 对于个别丢失的报文段，发送方不会出现超时重传，也不会误认为出现了拥塞（然而降低拥塞窗口层cwnd为1）。使用快重传可以使整个网络的吞吐量提高20%
* 发送方一旦收到三个重复确认，就知道现在只是丢失了个别报文段。于是不启动慢开始算法，而执行快恢复算法
  * 发送方将慢开始门限ssthresh值和拥塞窗口cwnd值调整为当前窗口的一半；开始执行拥塞避免算法
  * 有的快恢复实现是把快恢复开始时的拥塞窗口cwwnd的值再增大一些，即等于新的ssthresh+3
    * 既然发送方收到三个重复的确认，就表明有三个数据报文段已经离开了网络
    * 这三个报文段不再消耗网络资源而是停留在接收方的接收缓存中
    * 可见现在网络中不是堆积了报文段而是减少了三个报文段。因此可以适当把拥塞窗口扩大些
  
![图片](images/屏幕截图%202023-07-11%20160042.png)
![图片](images/屏幕截图%202023-07-11%20160953.png)

### TCP超市重传时间的选择

* 超时重传时间的选择是TCP最复杂的问题之一

![图片](images/屏幕截图%202023-07-11%20165102.png)

![图片](images/屏幕截图%202023-07-11%20165627.png)

* 不能直接使用某次测量得到的RTT样本来计算超时重传时间
* 利用每次测量得到的RTT样本，本次是加权往返时间RTTs（又称为平滑的往返时间）

  $RTT_{s1} = RTT_1 $
  $新的RTT_s = ( 1 - \alpha ) \times 旧的RTT_s + \alpha \times 新的RTT样本$
  在上式中，0 $\leq$ $\alpha$ < 1:
  若$\alpha$很接近与0，则新RTT样本对RTT~s~影响不大
  若$\alpha$很接近与1，则新RTT样本对RTT~s~影响很大
  已成为建议标准的RFC6298推荐的$\alpha$的值为1/8，即0.125
  
* 用这种方法得出的加权平均往返时间RTT~s~比测量出的RTT值更加平滑
* 显然，超时重传时间RTO应略大于加权平均往返时间$RTT_s$
* RFC6298建议使用的计算超时重传公式RTO：

$$
RTO=RTT_S + 4\times RTT_D
$$

![图片](images/屏幕截图%202023-07-11%20192133.png)

* 往返时间RTT的测量比较复杂

![图片](images/屏幕截图%202023-07-11%20192459.png)

* 针对出现超时重传时无法测准往返时间RTT的问题，Karn提出了一个算法：在计算加权平均往返时间$RTT_S$时，只要报文段重传了，就不采用其往返时间RTT样本。就是出现重传时，不重新计算$RTT_S$，然而超时重传时间RTO也不会重新计算
  * 又引起了新的问题。设想出现这样的情况：报文段的誓言突然增大了很多，并且之后很长一段时间都会保持这种时延。按根据Karn算法，不考虑重传的往返时间样本。这样超时重传时间就无法更新。这会导致反复被重传。
* 因此要对Karn算法进行修正。方法是：报文段每中传一次，就把超时重传时间增大一些。典型的做法是将RTO的值取为旧的RTO的值的2倍
![图片](images/屏幕截图%202023-07-11%20193335.png)

### TCP可靠传输的实现

* TCP基于以字节为单位的滑动窗口来实现可靠传输

![图片](images/屏幕截图%202023-07-11%20202949.png)
![图片](images/屏幕截图%202023-07-11%20203147.png)
![图片](images/屏幕截图%202023-07-11%20203548.png)

* 虽然发送方的发送窗口是根据接收方的接收窗口设置的，但在同一时刻，发送方的发送窗口并不总是和接收方的接收窗口一样大
  * 网络传输窗口值需要经历一定的时间滞后，并且这个时间还是不确定的。
  * 发送方还可能根据网络当时的拥塞情况适当减少自己的发送窗口尺寸。
* 对于不按序到达的数据应该如何处理，TCP并无明确规定。
  * 如果接收方把不按序到达的数据一律丢弃，那么接收窗口的管理将会比较简单，但这样对网络资源的利用十分不利。因为发送方会重传较多的数据。
  * TCP通常对不按序到达的数据是先临时存放在接收窗口中，等到字节流中所缺少的字节收到后，按时交付上层的应用进程
* TCP要求接收方必须有累计确认和捎带确认机制。这样可以减小传输开销。接收方可以在合适的时候发送确认，也可以在自己有数据要发送时把确认信息顺便捎带上。
  * 收方不应过分推迟发送确认，否则会导致发送方不必要的超时重传，反而浪费了网络的资源。
  
    TCP标准规定，确认推迟的时间不应该超过0.5秒。若收到一连串具有最大长度的报文段，则必须每隔一个报文段就发送一个确任[RFC 1122]

  * 捎带确认实际上并不经常发生，因为大多数应用程序很少同时在两个方向上发送数据。
* TCP的通信是全双工通信。通信中的每一方都在发送和接收报文段。因此，每一方都有自己的发送窗口和接收窗口。在谈到这些窗口时一定要弄清楚是哪一方的窗口

### TCP运输连接管理

* TCP是面向连接的协议，它基于运输连接来传送TCP报文段
* TCP运输连接的建立和释放是每一次面向连接的通信中必不可少的过程
* TCP运输连接有以下三个阶段

  ![图片](images/屏幕截图%202023-07-11%20205406.png)
* 运输链接管理就是使运输连接的建立和释放都能正常的进行

TCP运输连接管理-TCP的连接建立

* TCP的连接建立要解决以下三个问题
  1. 使TCP双方能够确知对方的存在
  2. 使TCP双方能够协商一些参数（如最大窗口值，是否使用窗口扩大选项和时间戳选项以及服务质量等）
  3. 使TCP双方能够对运输实体资源（如缓存大小、连接表中的项目等）进行分配
* TCP使用“三报文握手”建立连接
  ![图片](images/屏幕截图%202023-07-11%20212235.png)
  ![图片](images/屏幕截图%202023-07-11%20212139.png)

TCP运输连接管理-TCP的连接释放

* TCP通过“四报文挥手”来释放连接
  ![图片](images/屏幕截图%202023-07-11%20213400.png)
  ![图片](images/屏幕截图%202023-07-11%20213256.png)

![图片](images/屏幕截图%202023-07-11%20213614.png)

* TCP服务器进程每收到一次TCP客户进程的数据，就重新设置并启动保活计时器（两小时定时）
* 若保活计时器定时周期内未收到TCP客户进程发来的数据，则当保活计时器到时后，TCP服务器进程就像TCP客户进程发送一个探测报文段，以后则每隔75秒钟发送一次，若一连发送十个探测报文段后任无TCP客户进程的相应，TCP服务器进程就认为TCP客户进程所在主机出了故障，接着就关闭这个连接

### TCP报文段的首部格式

* 为了实现可靠传输，TCP采用了面向字节流的方式。
* 但TCP在发送数据时，是从发送缓存取出一部分或全部字节并给其添加一个首部使之成为TCP报文段后进行发送
  * 一个TCP报文段由首部和数据载荷两部分构成
  * TCP的全部功能都体现在它首部中各字段的作用

![图片](images/屏幕截图%202023-07-11%20214505.png)

**源端口**：占16比特，写入源端口号，用来识别发送该TCP报文段的应用进程
**目的端口**：占16比特，写入目的端口号，用来识别接受该TCP报文段的应用进程
![图片](images/屏幕截图%202023-07-11%20214945.png)
**序号**：占32比特，取值范围[0，$2^{32}$-1]，序号增加到最后一个后，下一个序号又回到0。
指出本TCP报文段数据载荷的第一个字节的序号
![图片](images/屏幕截图%202023-07-11%20215418.png)
**确认号**：占32比特，取值范围[0，$2^{32}$-1]，序号增加到最后一个后，下一个序号又回到0。
指出期望收到对方下一个TCP报文段数据载荷的第一个字节的序号，同时也是对之前收到的所有数据的确认。
若确认号=n，则表明到序号n-1为止的所有数据都已正确接受，期望接受数据号为n的数据
**确认标志位ACK**：取值为1时确认号字段才有效；取值为0时确认号字段无效
TCP规定，在连接建立后所有传送的TCP报文段都必须把ACK设置为1
![图片](images/屏幕截图%202023-07-11%20220140.png)
**数据偏移**：占4比特
用来指示出TCP报文段的数据载荷部分的起始处距离TCP报文段的起始处有多远
这个字段实际上是指出了TCP报文段的首部长度
$\qquad$ 首部长度为20字节，因此数据偏移字段的最小值为(0101)$_2$
$\qquad$ 首部长度为60字节，因此数据偏移字段的最大值为(1111)$_2$
![图片](images/屏幕截图%202023-07-11%20221035.png)
**保留**：占6比特，保留今后使用，但目前应设置为0
**窗口**：占16比特，以字节为单位。指出发送本报文段的一方的接受窗口
窗口值作为接收方让发送方设置其发送窗口的依据
这是以接收方的接受能力来控制发送方的发送能力，称为流量控制
**校验和**：占16比特，检查范围包括TCP报文段的首部和数据载荷两部分
在计算校验和时，要在TCP报文段的前面加上12字节的伪首部
**同步标志位SYN**：在TCP建立连接是用来同步序号
**终止标志位FIN**：用来释放TCP连接
**复位标志位RST**：用来复位TCP连接
当RST=1时，表明TCP连接出现了异常，必须释放连接，然后重新建立连接
RST置1还用来拒绝一个非法的连接或拒绝打开一个TCP连接
**推送标志位PSH**：接收方的TCP收到该标志为1的报文会尽快上交应用进程，而不必等到接收缓存都填满后再向上交付
**紧急标志位URG**：取值为1时紧急指针字段有效；取值为0紧急指针字段无效
**紧急指针**：占16比特，以字节为单位，用来指明紧急数据的长度。
当发送方有紧急数据时，可将紧急数据插队到发送缓存的最前面，并立刻封装到一个tcp报文段中进行发送。你指针会指出本报文段数据载荷部分包含了多长的紧急数据，紧急数据之后是普通数据。
**选项**
**最大报文段长度MSS选项**：TCP我们的数据载荷部分的最大长度
**窗口扩大选项**：为了扩大窗口（提高吞吐率。）
**时间戳选项**:用来计算往返时间RTT
用来处理序号超范围的情况,又称为防止序号绕回PAWS
**选择确认选项**
**填充**：由于选项的长度是可变的，因使用填充来确保报文段首部能够被4整除（因为数据偏移字段，也就是首部长度字段，是以4字节为单位的。）

## 应用层

### 应用层概述

* 应用层是计算机网络体系结构的最顶层，是设计和建立计算机网络的最终目的，也是计算机网络中发展最快的部分
  * 早期基于文本的应用（电子邮件、远程登录、文件传输、新闻组）
  * 20世纪90年代将因特网带入千家万户的万维网WWW
  * 当今流行的即使通信、P2P文件共享及各种音视频应用
  * 计算设备的小型化和“无处不在”，宽带住宅接入和无线接入的日益普及和迅速发展，为未来更多的新应用提供了广阔的舞台
* 我们以一些经典的网络应用为例学习有关网络应用的原理、协议和实现方面的知识
![图片](images/屏幕截图%202023-07-11%20224517.png)

### 客户/服务器（C/S方式）和对等方式（P2P方式）

* 网络应用程序运行在处于网络边缘的不同端系统上，通过彼此之间的通信来共同完成某项任务
* 开发一种新的网络应用首先要考虑的问题就是网络应用程序在各种端系统上的组织方式和它们之间的关系
  目前流行的主要有以下两种
  * 客户/服务器（）方式
    * 客户和服务器是指通信中所涉及的两个应用进程。
    * 客户/服务器方式所描述的是进程之间服务和被服务的关系
    * 客户是服务请求方，服务器是服务提供方
    * 服务器总是处于运行阶段，并等待客户的服务请求。服务器具有固定端口号（例如HTTP服务器的默认端口号为80。），而运行服务器的主机也具有固定的IP地址
    ![图片](images/屏幕截图%202023-07-12%20110351.png)
  * C/S方式是因特网上传统的，同时也是最成熟的方式，很多我们熟悉的网络应用采用的都是C/S方式。包括万维网WWW、电子邮件、文件传输FTP
  * 基于C/S方式的应用服务通常是服务集中型的，即应用服务集中在网络中比客户计算机少的很多的服务器计算机上
    * 由于一台服务器计算机要为多个客户机提供服务，在C/S应用中，常会出现服务器计算机跟不上众多客户机请求的情况
    * 为此，在C/S应用中，常用计算机群集（或服务器场）构建一个强大的虚拟服务器是
  * 对等（）方式
    * 在P2P方式中，没有固定的服务请求者和服务提供者，分布在网络边缘各端系统中的应用进程是对等的，被称为对等方。对方相互之间直接通信，每个对方既是服务的请求者，又是服务的提供者。
  * 目前，在英特网上流行的P2P应用主要包括P2P文件共享、即时通信、P2P流媒体、分布式储存等
  * 基于P2P的应用是服务分散型的，因为服务不是集中在少数几个服务器计算机中，而是分散在大量对等计算机中，因计算机并不为服务提供商所有，而是为个人控制的桌面计算机和笔记本电脑，它们通常位于住宅，校园和办公室中。
  ![图片](images/屏幕截图%202023-07-12%20111541.png)
  * P2P方式的最突出特性之一就是它的可扩展性。因为系统的每增加一个对等方，不仅增加的是服务的请求者，同时也增加了服务的提供者，一种性能不会因规模的增大而降低。
  * P2P方式具有成本上的优势，因为他通常不需要庞大的服务器设施和服务器带宽。为了降低成本，服务提供商对于P2P的方式用于应用的兴趣越来越大。

### 动态主机配置协议DHCP(Dynamic Host Configuration Protocol)

* DHCP的作用
![图片](images/屏幕截图%202023-07-12%20112056.png)
![图片](images/屏幕截图%202023-07-12%20112218.png)
* DHCP的工作过程
![图片](images/屏幕截图%202023-07-12%20113150.png)
![图片](images/屏幕截图%202023-07-12%20113112.png)
![图片](images/屏幕截图%202023-07-12%20113317.png)
![图片](images/屏幕截图%202023-07-12%20113434.png)
![图片](images/屏幕截图%202023-07-12%20113700.png)
* DHCP中继代理
![图片](images/屏幕截图%202023-07-12%20113839.png)
![图片](images/屏幕截图%202023-07-12%20114013.png)

### 域名系统DNS（）

* 域名系统DNS的作用
![图片](images/屏幕截图%202023-07-12%20114523.png)
![图片](images/屏幕截图%202023-07-12%20114627.png)
* 因特网采用层次树状的域名结构
* 域名的结构由若干个分量组成，各分量之间用“点”隔开，分别代表不同级别的域名
  * 每一集的域名都由英文字母和数字组成，不超过63个字符，不区分大小写字母
  * 级别最低的域名写在最左边，而级别最高的顶级域名写在最右边
  * 完整的域名不超过255个字符。
* 域名系统既不规定一个域名需要包含多少个下级域名，也不规定每一级的域名代表什么意思
* 各级域名由其上一级的域名管理机构管理，而最高的顶级域名则由英特网名称与数字地址分析机构ICANN进行管理
![图片](images/屏幕截图%202023-07-12%20123424.png)
* 顶级域名TLD（）分为以下三类
  * 国家顶级域名nTLD：采用ISO 3166的规定。如cn代表中国等
  * 通用顶级域名gTLD：最常见的通用顶级域名有七个，即：com（）、net（）、org（）、int（）、edu（）、gov（）、mil（）
  * 反向域arpa：用于反向域名解析，即IP地址反向解析为域名
* 在国家顶级域名下注册的二级域名均由该国家自行确定。例如顶级域名为jp的日本，当其教育和企业机构的二级域名定为ac和co，而不是edu和com
* 我国则将二级域名划分为以下两类
  * 类别域名共七个：ac、com（）、net（）、org（）、edu（）、gov（）、mil（）
  * 行政区域名：34个  如bj为北京
  
![图片](images/屏幕截图%202023-07-12%20124652.png)

* 域名和IP地址的映射关系必须保存在域名服务器中，供所有其他应用查询。显然不能将所有信息都存在一台域名服务器中。DNS使用分布在各地的域名服务器来实现域名到IP地址的转换
* 域名服务器可以划分为四种不同类型
  * 根域名服务器
    跟域名服务器是最高层次的域名服务器，每个跟域名服务器都知道所有的顶级域名服务器的域名及其IP地址。因特网上共有13个不同IP地址根域名服务器不是，尽管我们将这13个跟域名服务器的每一个都是为单个的服务器，但“每台服务器”实际上是由许多分布在世界各地的计算机构成的服务器群集。当本地域名服务器向根域名服务器发送查询请求时，路由器就把查询请求报文转发到离这个DNS客户最近的一个根域名服务器。这就加快了DNS的查询过程，同时也更合理地利用了因特网的资源。根域名服务器通常并不直接对域名进行解析，而是返回该域名所属顶级域名的顶级域名服务器的IP地址。
  * 顶级域名服务器
    这些域名服务器负责管理在该顶级域名服务器注册的所有二级域名。当收到DNS查询请求时就给出相应的回答（可能是最后的结果，也可能是下一级权限域名服务器的IP地址）
  * 权限域名服务器
    这些域名服务器负责管理某个区的域名。一个主机的域名都必须在某个权限域名服务器处注册登记。因此权限域名服务器知道其管理的域名和IP地址的映射关系。另外，权限域名服务器还知道其下级域名服务器的地址
  * 本地域名服务器
    本地域名服务器不属于上述的域名服务器的等级结构。换一个主机发送DNS请求报文时，这个报文就首先被送往该主机的本地域名服务器，本地域名服务器起着代理的作用，会将该报文转发到上述的域名服务器的等级结构中。每一个服务提供者ISP，一个大学，甚至一个大学里的学院，都可以拥有一个本地域名服务器，有时也称为默认域名服务器。本地域名服务器离用户较近，一般不超过几个路由器的距离，也有可能就在同一个局域网中。本地域名服务器的IP地址需要直接配置在需要域名解析的主机中
* 域名解析的过程
  * 递归查询
  * 迭代查询
![图片](images/屏幕截图%202023-07-12%20140941.png)
* 为了提高DNS的查询效率，并减轻根域名服务器的负荷和减少因特网上的DNS查询报文的数量，在域名服务器中广泛使用了高速缓存。高速缓存用来存放最近查询过的域名以及从何处获得域名映射信息的记录。
![图片](images/屏幕截图%202023-07-12%20141253.png)
* 由于域名到IP地址的映射关系并不是永久不变的，为保持高速缓冲中的内容正确，域名服务器应为每项内容设置计时器并删除超过合理时间的项
* 不但在本地域名服务器中需要高速缓存，在用户主机中也需要。许多用户主机在启动时从本地域名服务器上下载域名和IP地址的全部数据库，维护存放自己最近使用的域名的高速缓存，且只在从缓存中找不到域名时才向域名服务器查询，同理，主机也需要保持高速缓存中内容的正确性

### 文件传输协议FTP

* 将某台计算机中的文件通过网络传输到可能相距很远的另一台计算机中，是一项基本的网络应用，即文件传输
* 文件传输协议FTP（）是因特网上使用最广泛的文件传输协议
  * FTP屏蔽了各计算机系统的细节，因而适合于在异构网络中任何计算机之间传输文件
  * FTP提供交互式的访问，允许客户指明文件的类型与格式（如指明是否使用ASCLL码），允许文件具有存储权限（如访问文件的用户必须经过授权，并输入有效的口令）
* 在因特网发展的早期阶段，用FTP传送文件约占整个因特网的通信量的三分之一，而由电子邮件和域名系统所产生的通信量小于FTP所产生的通信量。只是到了1995年，万维网WWW的通信量才首次超过了FTP
![图片](images/屏幕截图%202023-07-12%20142922.png)
![图片](images/屏幕截图%202023-07-12%20143318.png)

### 电子邮件

* 电子邮件（）是最早流行的一种应用，并且人士当今因特网上最重要最实用的应用之一
* 传统的电话通信属于实时通信，存在以下两个缺点。
  * 电话通信的主叫和被叫必须同时在场。
  * 十分紧迫的电话也常常不必要的打断人们的工作和休息
* 而电子邮件与邮政系统的寄信相似
  * 发件人将邮件发送到自己使用的邮件服务器
  * 发件人的邮件服务器将收到的邮件按其目的地址转发到收件人邮件服务器中的收件人邮箱中
  * 收件人在方便的时候访问收件人邮箱服务器中自己的邮箱，或者收到的电子邮件
* 这个邮件使用方便、传出迅速，而且费用低廉。不仅可以传输文字信息，而且还可附上声音和图像。
* 电子邮件系统采用客户/服务器方式
* 电子邮件系统的三个主要组成构件：用户代理，邮件服务器，以及电子邮件所需的协议
  * 用户代理是用户与电子邮件系统的接口，又称电子邮件客户端软件
  * 邮件服务器是电子邮电系统的基础设施。用的网上所有的ISP都有邮件服务器，其功能是发送和接收邮件，同时还要负责维护用户的邮箱
  * 协议包括邮件发送协议（例如SMTP）和邮件读取协议（例如POP3，IMAP）
  
  ![图片](images/屏幕截图%202023-07-12%20144510.png)

* 简单邮件传送协议SMTP（）的基本工作原理
![图片](images/屏幕截图%202023-07-12%20164955.png)
* 电子邮件的信息格式并不是由SMTP定义的，而是在RFC 882中单独定义的。这个RFC文档在2008年更新为RFC 5322。一个电子邮件有信封和内容两部分。而内容又由首部和主体两部分组成
![图片](images/屏幕截图%202023-07-12%20165507.png)
* SMTP协议只能传送ASCLL码文本数据，不能传送可执行文件或其他二进制对象
* SMTP不能满足传送多媒体邮件（例如带有图片或音频）的需要。并且许多非英语国家的文字（例如中文、俄文）也无法使用SMTP传送
* 为了解决传送非ASCLL码文本的问题，提出了多用途因特网邮件扩展MIME（）
  * 增加了5个新的邮件首部字段，这些字段提供了有关邮件主体的信息
  * 定义了许多邮件内容的格式，对多媒体电子邮件的表示方法进行了标准化
  * 定义了传送编码，可对任何内容格式进行转换，而不会被邮件系统改变
* 实际上MIME不仅仅用于SMTP，也用于同样面向ASCLL字符的HTTP
![图片](images/屏幕截图%202023-07-12%20165954.png)

* 常用的邮件读取协议有以下两个
  * 邮局协议POP（），POP3是其第三个版本，是因特网的正式标准
    非常简单，功能有限的邮件读取协议。用户只能以下载并删除的方式或下载并保留的方式从邮件服务器下载邮件到用户方计算机。不允许用户在邮件服务器上管理自己的邮件。（比如创建文件夹，对邮件进行分类管理等）
  * 因特网邮件访问协议IMAP（），IMAP4是其第四个版本我不懂，目前还只是因特网建议标准
    功能比POP3强大的邮件读取协议。用户在自己的计算机上就可以操纵邮件服务器中的邮箱，就像在本地操纵一样，因此IMAP是一个联机协议
  * POP3和IMAP4都采用基于TCP对连接的客户/服务器对啊方式。POP3使用熟知端口110，IMAP4使用熟知端口143
* 基于万维网的电子邮件
  * 通过浏览器登录（提供用户名和口令）邮件服务器万维网网站就可以撰写、收发、阅读和管理电子邮件。这种工作模式与IMAP很类似，不同的是用户计算机无需安装专门的用户代理程序，只需要使用通用的万维网浏览器
  * 邮件服务器网站都提供非常强大和方便的邮件管理功能，用户可以在邮件服务器网站上管理和处理自己的邮件，而不需要将邮件下载到本地进行管理
![图片](images/屏幕截图%202023-07-12%20171554.png web)

### 万维网WWW

* 万维网WWW（）并非某种特殊的计算机网络。他是一个大规模的、联机式的信息储藏所，是运行在因特网上的一个分布式应用。
* 万维网利用网页之间的超链接将不同网站的网页连接成一张逻辑上的信息网
* 万维网是欧洲粒子物理实验室的TIM Berners-Lee最初于1989年3月提出的
* 1993年2月，第一个图形界面的浏览器Mosaic
* 1995年著名的Netscape Navigator浏览器上市
![图片](images/屏幕截图%202023-07-12%20172116.png)
* 目前比较流行的浏览器如下
 ![图片](images/屏幕截图%202023-07-12%20172355.png)
* 浏览器最重要的部分是渲染引擎，也就是浏览器内核。负责对网页内容进行解析和显示
  * 不同的浏览器内核对网页的内容解析也有不同，因此同一网页在不同内核的浏览器里显示的效果可能不同
  * 网页编写者需要在不同内核的浏览器中测试网页的显示效果。
* 为了方便的访问在世界范围的文档，万维网使用统一资源定位符URL来指明因特网上任何种类资源的位置
* URL的一般形式由以下四部分组成

![图片](images/屏幕截图%202023-07-12%20172737.png)
![图片](images/屏幕截图%202023-07-12%20172934.png)

* 超文本传输协议HTTP（）
  HTTP定义了浏览器（即万维网客户进程）怎样将万维网服务器请求万维网文档，以及万维网服务器怎样把万维网文档传送给浏览器
![图片](images/屏幕截图%202023-07-12%20173409.png)

* HTTP/1.0采用非持续连接方式。在该方式下，每次浏览器要请求一个文件都要与服务器建立TCP连接，当受到响应后就立即关闭连接
  * 每请求一个文档就要有两倍的RTT的开销。若一个网页上有很多引用对象（例如图片），那么请求每一个对象都需要花费2RTT的时间
  * 为了减少时延，浏览器通常会建立多个并行的TCP连接同时请求多个对象。但是，这会大量占用万维网服务器的资源，特别是万维网服务器往往要同时服务于大量客户的请求，为使其负担很重。
  
  ![图片](images/屏幕截图%202023-07-12%20180008.png)
* HTTP/1.1采用持续连接方式。在该方式下，在发送响应后仍然保持这条连接，使同一个客户（浏览器）和该服务器可以继续在这条链接上传输后续的HTTP请求报文和响应报文。这并不局限于共同一个页面上引用的对象，而是只要这些文档都在同一个服务器上就行。
  * 为了进一步提高效率，HTTP/1.1的持续连接，还可以使用流水线方式工作，即浏览器在收到HTTP的响应报文之前就能够连续发送多个请求报文。这样的一个接一个的请求报文到达服务器后，服务器就发回一个接一个的响应报文。这样就节省了很多个RTT时间，使TCP连接中的空闲时间减少，提高了下载文档的效率。
* HTTP的报文格式
![图片](images/屏幕截图%202023-07-12%20180844.png)
![图片](images/屏幕截图%202023-07-12%20180936.png)
![图片](images/屏幕截图%202023-07-12%20181115.png)

* 使用Cookie在服务器上记录用户信息
  * 早期的万维网应用非常简单，仅仅是用户查看存放在不同服务器上的各种静态文档。因此HTTP被设计为一种无状态的协议。这样可以简化服务器的设计。
  * 现在，用户可以通过万维网实现各种复杂的应用，如网上购物，电子商务等。这些应用往往需要万维网服务器能够识别用户。
  * Cookie用了一种机制使得万维网服务器能够“记住”用户，而无需用户主动提供用户标识信息。就是说,Cookie是一种对无状态的HTTP进行状态化的技术
* 使用Cookie在服务器上记录用户信息
![图片](images/屏幕截图%202023-07-12%20182001.png)
* 万维网缓存与代理服务器
  * 在万维网中还可以使用缓存机制以提高万维网的效率
  * 万维网缓存又称为Web缓存（），可位于客户机，也可位于中间系统上，位于中间系统上的web缓存又称为代理服务器（）
  * Web缓存把最近的一些请求和响应但存在本地磁盘中。当新请求到达时，若发现这个请求与暂时存放的请求相同，后返回暂存的响应，而不需要按URL的地址再次去因特网访问该资源。
![图片](images/屏幕截图%202023-07-12%20182622.png)
![图片](images/屏幕截图%202023-07-12%20182700.png)

### 网络安全
